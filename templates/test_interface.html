{% extends "base.html" %}

{% block title %}{{ test.title }} - ProctGuard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Monitoring Panel (Left Side) -->
        <div class="col-md-3 bg-dark text-white p-3">
            <h5><i class="fas fa-shield-alt"></i> Monitoring Status</h5>
            
            <!-- Student Info -->
            <div class="card bg-secondary text-white mb-3">
                <div class="card-body p-2">
                    <h6 class="card-title">Student Information</h6>
                    <small>Session: {{ session_id[:8] }}...</small>
                </div>
            </div>

            <!-- Camera Feed -->
            <div class="mb-3">
                <h6><i class="fas fa-camera"></i> Camera Feed</h6>
                <div class="border rounded">
                    <video id="studentVideo" width="100%" height="120" autoplay muted 
                           style="background: #333; border-radius: 4px;"></video>
                </div>
                <div id="cameraStatus" class="mt-1">
                    <small class="badge bg-warning">Connecting...</small>
                </div>
            </div>

            <!-- Monitoring Alerts -->
            <div class="mb-3">
                <h6><i class="fas fa-exclamation-triangle"></i> Alerts</h6>
                <div id="alertsContainer" class="small">
                    <div class="alert alert-success alert-sm p-2 m-1">
                        <i class="fas fa-check"></i> Monitoring active
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="mb-3">
                <h6><i class="fas fa-desktop"></i> System Status</h6>
                <div class="small">
                    <div id="tabFocusStatus" class="mb-1">
                        <i class="fas fa-circle text-success"></i> Tab Focus: Active
                    </div>
                    <div id="faceDetectionStatus" class="mb-1">
                        <i class="fas fa-circle text-warning"></i> Face Detection: Checking...
                    </div>
                    <div id="audioStatus" class="mb-1">
                        <i class="fas fa-circle text-warning"></i> Audio Monitor: Starting...
                    </div>
                </div>
            </div>

            <!-- Test Progress -->
            <div class="mb-3">
                <h6><i class="fas fa-clock"></i> Time Remaining</h6>
                <div class="progress mb-2" style="height: 20px;">
                    <div id="timeProgress" class="progress-bar bg-info" style="width: 100%">
                        {{ test.duration_minutes }}:00
                    </div>
                </div>
                <small id="timeDisplay">{{ test.duration_minutes }}:00</small>
            </div>
        </div>

        <!-- Test Content (Right Side) -->
        <div class="col-md-9 p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>{{ test.title }}</h2>
                    <p class="text-muted">{{ test.description }}</p>
                </div>
                <button id="submitTestBtn" class="btn btn-success btn-lg" onclick="submitTest()" disabled>
                    <i class="fas fa-check"></i> Submit Test
                </button>
            </div>

            <!-- Test Instructions -->
            <div class="alert alert-info mb-4">
                <h5><i class="fas fa-info-circle"></i> Instructions</h5>
                <ul class="mb-0">
                    <li>Answer all questions to the best of your ability</li>
                    <li>You can review and change answers before submitting</li>
                    <li>Stay focused on the test window - tab switching will be logged</li>
                    <li>Keep your face visible in the camera at all times</li>
                </ul>
            </div>

            <!-- Questions Container -->
            <div id="questionsContainer">
                {% for question in questions %}
                {% set i = loop.index0 %}
                <div class="card mb-4 question-card" data-question="{{ i }}">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="badge bg-primary me-2">{{ loop.index }}</span>
                            {{ question.question }}
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if question.type == 'multiple_choice' %}
                        <div class="form-check mb-2" style="margin-left: 20px;">
                            {% for option in question.options %}
                            {% set j = loop.index0 %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" 
                                       name="question_{{ i }}" 
                                       id="q{{ i }}_option{{ j }}" 
                                       value="{{ j }}"
                                       onchange="updateAnswers()">
                                <label class="form-check-label" for="q{{ i }}_option{{ j }}">
                                    {{ option }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Progress Indicator -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6>Progress: <span id="progressText">0/{{ questions|length }}</span> questions answered</h6>
                    <div class="progress">
                        <div id="answerProgress" class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Full Screen Modal for violations -->
<div class="modal fade" id="violationModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Monitoring Alert
                </h5>
            </div>
            <div class="modal-body text-center">
                <div id="violationMessage"></div>
                <p class="mt-3">Please ensure you follow the test guidelines.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    I Understand
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Test configuration
const testConfig = {
    sessionId: '{{ session_id }}',
    duration: {{ test.duration_minutes }},
    totalQuestions: {{ questions|length }}
};

// Initialize monitoring
let socket = null;
let videoStream = null;
let audioStream = null;
let testStartTime = Date.now();
let testAnswers = {};
let isTestActive = true;
let timeRemaining = testConfig.duration * 60; // seconds

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeSocket();
    initializeCamera();
    initializeAudio();
    initializeTimer();
    initializeTabMonitoring();
});

function initializeSocket() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('Connected to monitoring server');
        socket.emit('start_monitoring', { session_id: testConfig.sessionId });
    });

    socket.on('violation_detected', function(data) {
        showViolationAlert(data.violations);
    });
}

async function initializeCamera() {
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 640, height: 480 } 
        });
        
        const video = document.getElementById('studentVideo');
        video.srcObject = videoStream;
        
        document.getElementById('cameraStatus').innerHTML = 
            '<small class="badge bg-success">Camera Active</small>';
        document.getElementById('faceDetectionStatus').innerHTML = 
            '<i class="fas fa-circle text-success"></i> Face Detection: Active';
        
        // Start sending video frames for monitoring
        startVideoMonitoring();
        
    } catch (error) {
        console.error('Camera initialization failed:', error);
        document.getElementById('cameraStatus').innerHTML = 
            '<small class="badge bg-danger">Camera Failed</small>';
        showViolationAlert([{ description: 'Camera access required for test monitoring' }]);
    }
}

async function initializeAudio() {
    try {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        document.getElementById('audioStatus').innerHTML = 
            '<i class="fas fa-circle text-success"></i> Audio Monitor: Active';
        
        // Start audio monitoring
        startAudioMonitoring();
        
    } catch (error) {
        console.error('Audio initialization failed:', error);
        document.getElementById('audioStatus').innerHTML = 
            '<i class="fas fa-circle text-danger"></i> Audio Monitor: Failed';
    }
}

function startVideoMonitoring() {
    if (!videoStream) return;
    
    const video = document.getElementById('studentVideo');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 640;
    canvas.height = 480;
    
    setInterval(() => {
        if (!isTestActive) return;
        
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const frameData = canvas.toDataURL('image/jpeg', 0.8);
        
        socket.emit('video_frame', {
            session_id: testConfig.sessionId,
            frame: frameData
        });
    }, 1000); // Send frame every second
}

function startAudioMonitoring() {
    if (!audioStream) return;
    
    // Create audio context for processing
    const audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(audioStream);
    const analyser = audioContext.createAnalyser();
    
    source.connect(analyser);
    
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    
    setInterval(() => {
        if (!isTestActive) return;
        
        analyser.getByteFrequencyData(dataArray);
        
        // Simple audio analysis - send if there's significant audio activity
        const averageVolume = dataArray.reduce((sum, val) => sum + val, 0) / dataArray.length;
        
        if (averageVolume > 10) { // Threshold for audio activity
            socket.emit('audio_data', {
                session_id: testConfig.sessionId,
                audio: Array.from(dataArray).join(',') // Simplified audio data
            });
        }
    }, 2000); // Check every 2 seconds
}

function initializeTimer() {
    const timer = setInterval(() => {
        if (!isTestActive) {
            clearInterval(timer);
            return;
        }
        
        timeRemaining--;
        updateTimeDisplay();
        
        if (timeRemaining <= 0) {
            clearInterval(timer);
            submitTest();
        }
    }, 1000);
}

function updateTimeDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    document.getElementById('timeDisplay').textContent = timeStr;
    document.getElementById('timeProgress').textContent = timeStr;
    
    const progress = (timeRemaining / (testConfig.duration * 60)) * 100;
    document.getElementById('timeProgress').style.width = progress + '%';
    
    // Change color as time runs out
    const progressBar = document.getElementById('timeProgress');
    if (progress < 25) {
        progressBar.className = 'progress-bar bg-danger';
    } else if (progress < 50) {
        progressBar.className = 'progress-bar bg-warning';
    } else {
        progressBar.className = 'progress-bar bg-info';
    }
}

function initializeTabMonitoring() {
    let isTabFocused = true;
    
    window.addEventListener('focus', function() {
        if (!isTabFocused) {
            isTabFocused = true;
            document.getElementById('tabFocusStatus').innerHTML = 
                '<i class="fas fa-circle text-success"></i> Tab Focus: Active';
        }
    });
    
    window.addEventListener('blur', function() {
        if (isTabFocused && isTestActive) {
            isTabFocused = false;
            document.getElementById('tabFocusStatus').innerHTML = 
                '<i class="fas fa-circle text-danger"></i> Tab Focus: Lost';
            
            socket.emit('tab_switch', { session_id: testConfig.sessionId });
            
            showViolationAlert([{ 
                description: 'Tab switching detected - this has been logged'
            }]);
        }
    });
    
    // Prevent right-click context menu
    document.addEventListener('contextmenu', e => e.preventDefault());
    
    // Prevent common keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.altKey || e.ctrlKey || e.key === 'F12') {
            e.preventDefault();
            showViolationAlert([{ 
                description: 'Restricted key combination detected'
            }]);
        }
    });
}

function updateAnswers() {
    let answeredCount = 0;
    
    for (let i = 0; i < testConfig.totalQuestions; i++) {
        const selectedOption = document.querySelector(`input[name="question_${i}"]:checked`);
        if (selectedOption) {
            testAnswers[i] = parseInt(selectedOption.value);
            answeredCount++;
        }
    }
    
    const progress = (answeredCount / testConfig.totalQuestions) * 100;
    document.getElementById('answerProgress').style.width = progress + '%';
    document.getElementById('progressText').textContent = 
        `${answeredCount}/${testConfig.totalQuestions}`;
    
    // Enable submit button when all questions are answered
    const submitBtn = document.getElementById('submitTestBtn');
    if (answeredCount === testConfig.totalQuestions) {
        submitBtn.disabled = false;
        submitBtn.className = 'btn btn-success btn-lg';
    } else {
        submitBtn.disabled = true;
        submitBtn.className = 'btn btn-secondary btn-lg';
    }
}

function showViolationAlert(violations) {
    const violationMessages = violations.map(v => v.description).join('<br>');
    document.getElementById('violationMessage').innerHTML = 
        `<div class="alert alert-danger">${violationMessages}</div>`;
    
    const modal = new bootstrap.Modal(document.getElementById('violationModal'));
    modal.show();
    
    // Add to alerts container
    const alertsContainer = document.getElementById('alertsContainer');
    const alertTime = new Date().toLocaleTimeString();
    alertsContainer.innerHTML += `
        <div class="alert alert-danger alert-sm p-2 m-1">
            <i class="fas fa-exclamation-triangle"></i> ${alertTime}: ${violations[0].description}
        </div>
    `;
    
    // Scroll to show latest alert
    alertsContainer.scrollTop = alertsContainer.scrollHeight;
}

function submitTest() {
    if (!isTestActive) return;
    
    isTestActive = false;
    
    // Stop all monitoring
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
    if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
    }
    
    socket.emit('stop_monitoring', { session_id: testConfig.sessionId });
    
    // Submit answers
    fetch('/api/submit_test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: testConfig.sessionId,
            answers: testAnswers
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Test submitted successfully! Your score: ${data.score.toFixed(1)}%`);
            window.location.href = '/student';
        } else {
            alert('Error submitting test. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting test. Please contact support.');
    });
}

// Prevent page refresh/navigation during test
window.addEventListener('beforeunload', function(e) {
    if (isTestActive) {
        e.preventDefault();
        e.returnValue = 'Are you sure you want to leave the test? Your progress will be lost.';
    }
});
</script>
{% endblock %}